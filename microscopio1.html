<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microscopio Interactivo Pro - BioPhysics 4.0</title>
    <link rel="stylesheet" href="Hoja de estilo corrector.css">
    
    <style>
        /* --- VARIABLES --- */
        :root {
            --color-neon: #4ade80;
            --color-error: #ff5f56;
            --color-dark-bg: rgba(15, 15, 15, 0.95);
            --color-border: rgba(255, 255, 255, 0.15);
        }

        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; background: #000; user-select: none; }
        
        /* --- UI GENERAL --- */
        .ui-btn {
            background: var(--color-dark-bg);
            border: 1px solid var(--color-border);
            color: #ccc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .ui-btn:hover {
            border-color: var(--color-neon);
            color: var(--color-neon);
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);
        }

        .top-right-ui { position: absolute; top: 20px; right: 20px; z-index: 2000; }
        .bottom-left-ui { position: absolute; bottom: 30px; left: 30px; z-index: 2000; }
        
        /* --- NUEVO: PANTALLA DE BLOQUEO (SIN MUESTRAS) --- */
        #bloqueo-sin-muestras {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); /* Casi opaco */
            z-index: 5000; /* Por encima de todo */
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            display: none; /* Oculto por defecto */
        }
        
        .caja-alerta {
            background: #1a1a1a; padding: 40px; border-radius: 20px;
            border: 2px solid var(--color-error);
            text-align: center; color: white;
            box-shadow: 0 0 50px rgba(255, 95, 86, 0.3);
            max-width: 500px;
        }

        .caja-alerta h1 { margin-top: 0; color: var(--color-error); font-size: 2rem; text-transform: uppercase; }
        .caja-alerta p { font-size: 1.1rem; line-height: 1.6; color: #ccc; margin-bottom: 30px; }
        
        .btn-accion-urgente {
            background: var(--color-error); color: white; border: none;
            padding: 15px 30px; font-size: 1.1rem; font-weight: bold;
            border-radius: 50px; cursor: pointer; transition: transform 0.2s;
            text-decoration: none; display: inline-block;
        }
        .btn-accion-urgente:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 95, 86, 0.6); }


        /* --- SELECTOR LATERAL DE MUESTRAS --- */
        #selector-muestras {
            position: absolute;
            top: 50%; left: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 2000;
            background: rgba(0,0,0,0.6);
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--color-border);
            max-height: 80vh;
            overflow-y: auto;
        }

        .btn-muestra {
            width: 35px; height: 35px;
            border-radius: 50%;
            border: 1px solid #444;
            background: #222;
            color: #666;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; justify-content: center; align-items: center;
        }

        .btn-muestra:hover { transform: scale(1.1); }

        .btn-muestra.cultivada {
            background: rgba(74, 222, 128, 0.2);
            color: var(--color-neon);
            border-color: var(--color-neon);
            box-shadow: 0 0 5px rgba(74, 222, 128, 0.4);
        }

        .btn-muestra.vacia {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-muestra.seleccionada {
            background: var(--color-neon);
            color: #000;
            border-color: #fff;
            box-shadow: 0 0 15px var(--color-neon);
            transform: scale(1.2);
        }

        #etiqueta-muestra {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white;
            padding: 5px 15px; border-radius: 20px; font-family: monospace;
            z-index: 2000; pointer-events: none; border: 1px solid #555;
        }

        #mensaje-vacio {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.3); font-size: 2rem; font-weight: bold;
            pointer-events: none; z-index: 50; display: none; text-align: center;
        }

        /* --- MICROSCOPIO --- */
        #microscopio-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #ffffff;
            overflow: hidden; z-index: 1; cursor: grab;
        }
        #microscopio-container:active { cursor: grabbing; }

        #portaobjetos {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            transform-origin: center center; will-change: transform;
            transition: transform 0.1s linear; 
        }
        .suavizar-zoom { transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important; }

        /* --- BACTERIAS --- */
        .bacteria {
            position: absolute;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            pointer-events: auto;
            cursor: pointer; will-change: transform;
        }
        .bacteria::after {
            content: ''; position: absolute;
            top: -20px; left: -20px; right: -20px; bottom: -20px;
        }
        .bacteria:hover {
            filter: drop-shadow(0 0 8px var(--color-neon)); z-index: 100;
        }

        /* --- OVERLAY LENTE --- */
        #lente-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 100; pointer-events: none;
            background: radial-gradient(circle at center, transparent 70%, rgba(0,0,0,0.1) 45%, rgba(0,0,0,0.85) 75%, black 100%);
        }

        /* --- CONTROLES ZOOM --- */
        #controles-zoom {
    position: fixed;
    right: 30px;
    bottom: 140px;          /* s√∫belo para que no choque con la regla */
    z-index: 2500;

    display: flex;          /* ‚úÖ horizontal */
    flex-direction: row;
    gap: 8px;

    background: var(--color-dark-bg);
    padding: 10px 12px;
    border-radius: 50px;
    border: 1px solid var(--color-border);
}

        .btn-zoom {
            width: 45px; height: 45px; border-radius: 50%;
            border: 1px solid transparent; background: rgba(255,255,255,0.05);
            color: #888; font-weight: 700; font-size: 0.75rem;
            cursor: pointer; transition: 0.2s;
        }
        .btn-zoom:hover { color: white; background: rgba(255,255,255,0.1); }
        .btn-zoom.activo {
            background: var(--color-neon); color: #000;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.5); transform: scale(1.1);
        }

        /* --- MODAL --- */
        #modal-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #modal-container.visible { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            position: relative; width: 80vw; max-width: 700px; aspect-ratio: 4/3;
            background: #222; border-radius: 15px; border: 2px solid #444;
            overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; 
        }
        .btn-cerrar {
            position: absolute; top: 15px; right: 15px; width: 35px; height: 35px;
            border-radius: 50%; background: #ff5f56; border: none; color: white;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10;
        }
        
        .modal-content {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #ccc; padding: 20px; box-sizing: border-box; text-align: center;
        }
        .modal-content img {
            max-height: 55%; margin-bottom: 20px;
            border-radius: 10px; border: 1px solid #444;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .modal-content h2 { color: white; margin: 0 0 10px 0; font-size: 1.8rem; text-shadow: 0 0 10px rgba(74,222,128,0.3); }
        .modal-content p { font-size: 1.1rem; line-height: 1.5; max-width: 80%; }

    </style>
</head>

<body id="pag1">

    <div id="bloqueo-sin-muestras">
        <div class="caja-alerta">
            <h1>‚ö† Sin Muestras Activas</h1>
            <p>No se han detectado cultivos bacterianos en las placas Petri. El microscopio no puede funcionar sin muestras biol√≥gicas.</p>
            <p>Debes generar un cultivo primero.</p>
            <a href="petri.html" class="btn-accion-urgente">Ir a Cultivar üß´</a>
        </div>
    </div>

    <div id="microscopio-container">
        <div id="portaobjetos" class="suavizar-zoom"></div>
        <div id="mensaje-vacio">MUESTRA SIN CULTIVO<br><span style="font-size:1rem; font-weight:normal;">Regresa a la mesa para cultivarla</span></div>
    </div>
    <div id="lente-overlay"></div>

    <div id="selector-muestras">
        </div>

    <div id="etiqueta-muestra">Muestra Activa: #--</div>

    <div class="top-right-ui">
        <button onclick="guardarPartidaManual()" class="ui-btn" id="btn-guardar-ui">üíæ Guardar Estado</button>
        <span id="msg-guardado" style="display:none; color: var(--color-neon); margin-left: 10px; font-weight:bold;">¬°Guardado!</span>
    </div>

    <div class="bottom-left-ui">
        <a href="petri.html" class="ui-btn">‚¨Ö Regresar a Mesa Petri</a>
    </div>

    <div id="controles-zoom">
        <button class="btn-zoom activo" onclick="aplicarZoom(0.6, this)">4x</button>
        <button class="btn-zoom" onclick="aplicarZoom(1.0, this)">10x</button>
        <button class="btn-zoom" onclick="aplicarZoom(1.8, this)">40x</button>
        <button class="btn-zoom" onclick="aplicarZoom(2.5, this)">100x</button>
    </div>

    <div id="modal-container">
        <div class="modal-box">
            <button class="btn-cerrar" onclick="cerrarModal()">√ó</button>
            <div class="modal-content">
                <img id="modal-img" src="" alt="Detalle Bacteria">
                <h2 id="modal-titulo">T√≠tulo</h2>
                <p id="modal-desc">Descripci√≥n.</p>
            </div>
        </div>
    </div>

<script>
    // --- 0. L√ìGICA DE MUESTRAS Y RECETAS ---
    const RECETAS_BIOLOGICAS = {
        1: { 5: 1.0 },                      // 100% Lactobacillus
        2: { 0: 0.8, 2: 0.2 },              // E. Coli + Salmonella
        3: { 3: 0.7, 1: 0.3 },              // Pseudomona + Tuberculosis
        4: { 4: 1.0 },                      // 100% Estreptococos
        5: { 6: 0.9, 1: 0.1 },              // Treponema + Tuberculosis
        6: { 2: 0.5, 3: 0.5 },              // Mix R√°pido
        7: { 0: 0.2, 1: 0.2, 4: 0.2, 6: 0.4 } // Caos
    };

    const CATALOGO_BACTERIAS = [
        { sprite: 'Assets/Microbact1.png', infoImg: 'Assets/real_Ecoli.png', titulo: 'Escherichia Coli', desc: 'Tipo bacilo, es la "celebridad" del mundo microsc√≥pico, es el organismo m√°s estudiado por la ciencia. Es una bacteria con forma de bast√≥n que vive naturalmente en los intestinos de los seres humanos y animales de sangre caliente. Gracias a su simplicidad, los cient√≠ficos la usan como una "impresora biol√≥gica". Le insertan genes humanos (usando pl√°smidos) para que fabrique Insulina artificial para los diab√©ticos' },
        { sprite: 'Assets/Microbact11.png', infoImg: 'Assets/real_tuberculosis.png', titulo: 'Mycobacterium Tuberculosis', desc: 'Tipo bacilo, es un bacilo muy delgado y recto. Tarda casi un d√≠a entero (20 horas) en dividirse una sola vez. Su pared celular no es normal; es extraordinariamente gruesa y est√° hecha de cera (√°cidos mic√≥licos). Cuando intentas mojar una vela, el agua resbala. Eso es exactamente lo que pasa con los antibi√≥ticos y los desinfectantes comunes' },
        { sprite: 'Assets/Microbact8.png', infoImg: 'Assets/real_salmonella.png', titulo: 'Salmonella', desc: 'Tipo bacilo, A diferencia de otras bacterias que tienen un solo flagelo al final, la salmonella tiene flagelos cubriendo todo su cuerpo. Nada velozmente buscando d√≥nde adherirse. Es famosa por esconderse en alimentos crudos como el pollo, los huevos o la leche sin pasteurizar' },
        { sprite: 'Assets/Microbact7.png', infoImg: 'Assets/real_pseudomona.png', titulo: 'Pseudomona Aeruginosa', desc: 'Tipo bacilo, tiene un motor rotatorio real llamada flagelo polar. Es una m√°quina hecha de prote√≠nas que gira a miles de revoluciones por minuto. Se encuentra en casi cualquier lugar donde haya agua o humedad: suelo, piscinas, fregaderos y hospitales.' },
        { sprite: 'Assets/Microbact10.png', infoImg: 'Assets/real_streptococo.png', titulo: 'Estreptococos', desc: 'Tipo coco, cuando una de estas bacterias se reproduce (se parte en dos), lo hace siempre en la misma direcci√≥n (un solo plano), pero las dos nuevas c√©lulas no se sueltan. Esto provoca que se formen largas filas o cadenas que pueden retorcerse. Es el culpable de las infecciones de garganta dolorosas (faringitis) y la fiebre escarlatina' },
        { sprite: 'Assets/Microbact4.png', infoImg: 'Assets/real_lactobacilus.png', titulo: 'Lactobacillus', desc: 'Tipo bacilo, a menudo les gusta vivir conectadas, formando largas cadenas (estreptobacilos), pareciendo vagones de tren microsc√≥picos. Se alimentan de az√∫cares (como la lactosa de la leche). No producen toxinas, sino √°cido l√°ctico y son las responsables de convertir la leche l√≠quida en yogur espeso y el queso' },
        { sprite: 'Assets/Microbact9.png', infoImg: 'Assets/real_Sifilis.png', titulo: 'Treponema Pallidum', desc: 'Assets/real_Sifilis.png', titulo: 'Treponema pallidum', desc: 'Tipo Espiroqueta, Conocida por su enfermedad S√≠filis. Sus flagelos est√°n escondidos entre su "piel" y su cuerpo, recorri√©ndola de punta a punta como si fueran la columna vertebral. El contagio ocurre principalmente por contacto sexual. La bacteria taladra a modo de sacacorchos una peque√±a herida o √∫lcera llamada chancro en el lugar por donde entr√≥' }
    ];

    const contenedor = document.getElementById('portaobjetos');
    const msgVacio = document.getElementById('mensaje-vacio');
    let bacterias = [];
    let pausado = false;
    let idMuestraActual = 1;
    let datosGuardados = {}; 

    // --- 1. GESTI√ìN DE MUESTRAS Y VALIDACI√ìN ---

    function inicializarSistema() {
        datosGuardados = JSON.parse(localStorage.getItem('BacterialFarm_Save1')) || { cajas: {} };

        // --- VALIDACI√ìN DE SEGURIDAD: ¬øHAY CULTIVOS? ---
        let hayCultivos = false;
        if (datosGuardados.cajas) {
            // Buscamos si existe al menos UNA caja completada
            for (const key in datosGuardados.cajas) {
                if (datosGuardados.cajas[key].completada) {
                    hayCultivos = true;
                    break;
                }
            }
        }

        if (!hayCultivos) {
            // SI NO HAY CULTIVOS: Mostramos el bloqueo y detenemos la ejecuci√≥n
            document.getElementById('bloqueo-sin-muestras').style.display = 'flex';
            return; // Importante: Detiene el resto de la funci√≥n para no cargar nada m√°s
        }

        // SI HAY CULTIVOS: Continuamos normal
        const params = new URLSearchParams(window.location.search);
        let idInicial = params.get('id');
        
        if (!idInicial && datosGuardados.muestraObservada) {
            idInicial = datosGuardados.muestraObservada;
        }
        
        cambiarMuestra(parseInt(idInicial) || 1, false); 
        generarBotonesLaterales();
    }

    function generarBotonesLaterales() {
        const selector = document.getElementById('selector-muestras');
        selector.innerHTML = ''; 

        for (let i = 1; i <= 12; i++) {
            const btn = document.createElement('button');
            btn.className = 'btn-muestra';
            btn.innerText = i;
            btn.id = `btn-muestra-${i}`;
            
            const tieneDatos = datosGuardados.cajas && datosGuardados.cajas[i] && datosGuardados.cajas[i].completada;
            
            if (tieneDatos) {
                btn.classList.add('cultivada');
                btn.title = "Muestra Cultivada";
            } else {
                btn.classList.add('vacia');
                btn.title = "Muestra Vac√≠a";
            }

            btn.onclick = () => cambiarMuestra(i, true);
            selector.appendChild(btn);
        }
        actualizarEstiloBotones();
    }

    function actualizarEstiloBotones() {
        document.querySelectorAll('.btn-muestra').forEach(b => b.classList.remove('seleccionada'));
        const btnActual = document.getElementById(`btn-muestra-${idMuestraActual}`);
        if(btnActual) btnActual.classList.add('seleccionada');
    }

    function cambiarMuestra(id, guardarCambio) {
        if (id < 1 || id > 12) return;
        
        idMuestraActual = id;
        document.getElementById('etiqueta-muestra').innerText = `Muestra Activa: #${id}`;
        
        limpiarEscenario();
        actualizarEstiloBotones();

        const tieneDatos = datosGuardados.cajas && datosGuardados.cajas[id] && datosGuardados.cajas[id].completada;

        if (tieneDatos) {
            msgVacio.style.display = 'none';
            const idReceta = ((id - 1) % 7) + 1;
            generarBacterias(idReceta);
        } else {
            msgVacio.style.display = 'block';
        }

        if (guardarCambio) {
            datosGuardados.muestraObservada = id;
            localStorage.setItem('BacterialFarm_Save1', JSON.stringify(datosGuardados));
        }
    }

    function limpiarEscenario() {
        bacterias.forEach(b => {
            if(b.element && b.element.parentNode) {
                b.element.parentNode.removeChild(b.element);
            }
        });
        bacterias = [];
    }

    function obtenerBacteriaSegunReceta(idReceta) {
        const receta = RECETAS_BIOLOGICAS[idReceta];
        const rand = Math.random();
        let acumulado = 0;
        for (const [indiceStr, probabilidad] of Object.entries(receta)) {
            acumulado += probabilidad;
            if (rand <= acumulado) return parseInt(indiceStr);
        }
        return parseInt(Object.keys(receta)[0]);
    }

    // --- 2. GENERACI√ìN DE VIDA ---
    function generarBacterias(idReceta) {
        const cantidadTotal = 80;
        
        for (let i = 0; i < cantidadTotal; i++) {
            const idx = obtenerBacteriaSegunReceta(idReceta);
            
            if (idx === 4 || idx === 5) {
                const liderX = (Math.random() * window.innerWidth * 2) - window.innerWidth;
                const liderY = (Math.random() * window.innerHeight * 2) - window.innerHeight;
                
                const lider = new Bacteria(idx, liderX, liderY);
                bacterias.push(lider);

                const chainLength = 3 + Math.floor(Math.random() * 6);
                let offsetX = 0; let offsetY = 0;
                const formationAngle = Math.random() * Math.PI * 2; 

                for(let k = 0; k < chainLength; k++) {
                    const dist = 25 * (k + 1);
                    const curvatura = Math.sin(k * 0.5) * 15; 
                    offsetX = Math.cos(formationAngle) * dist + Math.cos(formationAngle + Math.PI/2) * curvatura;
                    offsetY = Math.sin(formationAngle) * dist + Math.sin(formationAngle + Math.PI/2) * curvatura;

                    bacterias.push(new Bacteria(idx, liderX + offsetX, liderY + offsetY, true, {
                        speed: lider.speed, angle: lider.angle
                    }));
                }
                i += Math.floor(chainLength / 2);
            } else {
                bacterias.push(new Bacteria(idx));
            }
        }
    }

    // --- 3. CLASE BACTERIA ---
    class Bacteria {
        constructor(imgIndex, x, y, isGroupMember = false, parentData = null) {
            this.element = document.createElement('div');
            this.element.classList.add('bacteria');
            this.metadata = CATALOGO_BACTERIAS[imgIndex];
            this.element.style.backgroundImage = `url('${this.metadata.sprite}')`;
            
            if (imgIndex === 2 || imgIndex === 3 || imgIndex === 6) this.tipo = 'rapida';
            else if (imgIndex === 4 || imgIndex === 5) this.tipo = 'colonia';
            else this.tipo = 'normal';

            let baseSize = 40;
            if (this.tipo === 'colonia') baseSize = 30;
            const size = baseSize + Math.random() * 20;
            this.element.style.width = `${size}px`;
            this.element.style.height = `${size}px`;

            const mundoW = window.innerWidth * 3;
            const mundoH = window.innerHeight * 3;
            this.limitX = mundoW / 2;
            this.limitY = mundoH / 2;
            
            this.x = x || (Math.random() * mundoW - mundoW/3);
            this.y = y || (Math.random() * mundoH - mundoH/3);
            this.angle = Math.random() * 360; 
            this.vx = 0; this.vy = 0; this.vRot = 0;

            if (this.tipo === 'rapida') {
                this.speed = 2 + Math.random() * 1.5;
                this.angle = Math.random() * 360;
            } else if (this.tipo === 'colonia') {
                this.speed = 0.4;
                if(isGroupMember && parentData) {
                    this.speed = parentData.speed;
                    this.angle = parentData.angle;
                    this.vRot = (Math.random() - 0.5) * 0.2; 
                } else {
                    this.angle = Math.random() * 360;
                    this.vRot = (Math.random() - 0.5) * 0.2;
                }
            } else {
                this.speed = 0.8;
                this.vRot = (Math.random() - 0.5) * 1;
            }

            this.element.addEventListener('click', (e) => {
                if(!isMapDragging) { e.stopPropagation(); abrirModal(this.metadata); }
            });
            contenedor.appendChild(this.element);
        }

        update() {
            if (pausado) return;
            if (this.tipo === 'rapida') {
                const rads = this.angle * (Math.PI / 180);
                this.vx = Math.cos(rads) * this.speed;
                this.vy = Math.sin(rads) * this.speed;
                this.x += this.vx; this.y += this.vy;
                const vibracion = (Math.random() - 0.5) * 15; 
                this.element.style.transform = `translate(${this.x}px, ${this.y}px) rotate(${this.angle + 90 + vibracion}deg)`;
                if (Math.random() < 0.02) this.angle += (Math.random() - 0.5) * 180;
                this.checkBounds(true);
            } else {
                const rads = this.angle * (Math.PI / 180);
                this.vx = Math.cos(rads) * this.speed;
                this.vy = Math.sin(rads) * this.speed;
                this.x += this.vx; this.y += this.vy;
                this.rotation = (this.rotation || 0) + this.vRot;
                this.checkBounds(false);
                this.element.style.transform = `translate(${this.x}px, ${this.y}px) rotate(${this.rotation}deg)`;
            }
        }

        checkBounds(isRapida) {
            let fuera = false;
            if (this.x > this.limitX) { this.x = this.limitX - 10; fuera = true; }
            else if (this.x < -this.limitX) { this.x = -this.limitX + 10; fuera = true; }
            if (this.y > this.limitY) { this.y = this.limitY - 10; fuera = true; }
            else if (this.y < -this.limitY) { this.y = -this.limitY + 10; fuera = true; }

            if (fuera) {
                if (isRapida) {
                    const angleToCenter = Math.atan2(-this.y, -this.x) * (180 / Math.PI);
                    this.angle = angleToCenter + (Math.random() - 0.5) * 120;
                } else {
                    this.angle = (this.x > this.limitX || this.x < -this.limitX) ? 180 - this.angle : 360 - this.angle;
                }
            }
        }
    }

    function loop() {
        bacterias.forEach(b => b.update());
        requestAnimationFrame(loop);
    }

    let currentZoom = 0.6; let panX = 0; let panY = 0;
    let isMapDragging = false; let startX, startY;

    function updateTransform(smooth = false) {
        if(smooth) contenedor.classList.add('suavizar-zoom');
        else contenedor.classList.remove('suavizar-zoom');
        contenedor.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
    }

    function aplicarZoom(zoomLevel, btn) {
        currentZoom = zoomLevel; updateTransform(true);
        document.querySelectorAll('.btn-zoom').forEach(b => b.classList.remove('activo'));
        btn.classList.add('activo');
    }

    const zona = document.getElementById('microscopio-container');
    zona.addEventListener('mousedown', (e) => {
        isMapDragging = false; 
        startX = e.clientX - panX; startY = e.clientY - panY;
        const ix = e.clientX; const iy = e.clientY;
        const onMouseMove = (me) => {
            if(Math.hypot(me.clientX - ix, me.clientY - iy) > 5) {
                isMapDragging = true; panX = me.clientX - startX; panY = me.clientY - startY;
                updateTransform(false); 
            }
        };
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            setTimeout(() => isMapDragging = false, 50); 
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    const modal = document.getElementById('modal-container');
    const modalImg = document.getElementById('modal-img');
    const modalTitulo = document.getElementById('modal-titulo');
    const modalDesc = document.getElementById('modal-desc');

    function abrirModal(datos) {
        pausado = true;
        modalImg.src = datos.infoImg; modalTitulo.innerText = datos.titulo; modalDesc.innerText = datos.desc;
        modal.classList.add('visible');
    }
    function cerrarModal() { modal.classList.remove('visible'); pausado = false; }

    function guardarPartidaManual() {
        datosGuardados.nivel = "Microscopio";
        datosGuardados.fecha = new Date().toLocaleString();
        datosGuardados.muestraObservada = idMuestraActual;
        localStorage.setItem('BacterialFarm_Save1', JSON.stringify(datosGuardados));
        
        const btn = document.getElementById('btn-guardar-ui');
        const msg = document.getElementById('msg-guardado');
        btn.style.color = "var(--color-neon)"; btn.style.borderColor = "var(--color-neon)";
        msg.style.display = "inline";
        setTimeout(() => {
            btn.style.color = "#ccc"; btn.style.borderColor = "var(--color-border)"; msg.style.display = "none";
        }, 2000);
    }

    inicializarSistema();
    loop();
    updateTransform(true);

</script>

<script src="audio-manager.js"></script>
<script>iniciarMusicaPagina(1);</script>

<script src="hud-manager.js"></script>
<script>
  // Inicial: coincide con el bot√≥n marcado "activo" (4x = zoom 0.6)
  window.addEventListener('DOMContentLoaded', () => {
    actualizarEscalaHUD('mm', 4.5);
  });
</script>


</body>
</html>